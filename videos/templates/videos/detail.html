{% extends 'channels/base.html' %}
{% load time_filters %}
{% load dict_filters %}

{% block title %}{{ video.title }} - {{ video.channel.name }}{% endblock %}

{% block content %}
<div class="container-fluid my-4">
  <div class="row g-3">
    <!-- 🎥 Left: Video Player & Details -->
    <div class="col-lg-8">
      <div class="video-container">
        <!-- ✅ YouTube Embed -->
        {% with video.youtube_url as url %}
          {% if "watch?v=" in url %}
            {% with url|cut:"https://www.youtube.com/watch?v=" as video_id %}
              <iframe id="player" width="100%" height="500"
                      src="https://www.youtube.com/embed/{{ video_id }}?enablejsapi=1&start={{ progress.current_time|default:0 }}"
                      frameborder="0" allowfullscreen></iframe>
            {% endwith %}
          {% elif "youtu.be/" in url %}
            {% with url|cut:"https://youtu.be/" as video_id %}
              <iframe id="player" width="100%" height="500"
                      src="https://www.youtube.com/embed/{{ video_id }}?enablejsapi=1&start={{ progress.current_time|default:0 }}"
                      frameborder="0" allowfullscreen></iframe>
            {% endwith %}
          {% else %}
            <iframe id="player" width="100%" height="500"
                    src="{{ url }}?enablejsapi=1&start={{ progress.current_time|default:0 }}"
                    frameborder="0" allowfullscreen></iframe>
          {% endif %}
        {% endwith %}
      </div>

      <!-- Video Title & Channel Info -->
      <div class="video-info mt-3 p-3 bg-white rounded-3 shadow-sm">
        <h3 class="video-title fw-bold mb-2">{{ video.title }}</h3>
        
        <!-- Channel Info & Stats -->
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <div class="channel-avatar me-2">
              {% if video.channel.ch_logo %}
                <img src="{{ video.channel.ch_logo }}" alt="{{ video.channel.name }}" class="rounded-circle">
              {% else %}
                <div class="avatar-placeholder rounded-circle bg-primary text-white d-flex align-items-center justify-content-center">
                  {{ video.channel.name|slice:":1"|upper }}
                </div>
              {% endif %}
            </div>
            <div>
              <h6 class="mb-0 fw-semibold">{{ video.channel.name }}</h6>
              <small class="text-muted">Video {{ video.order }} of {{ videos|length }}</small>
            </div>
          </div>
          
          <!-- Progress Badge -->
          {% if user.is_authenticated %}
            <div class="progress-badge">
              <span class="badge bg-primary px-3 py-2" id="progress-badge">
                <i class="bi bi-clock-history"></i> 
                {% with progress_dict|dict_get:video.id as prog %}
                  {{ prog.watched_percentage|default:"0"|floatformat:0 }}% Complete
                {% endwith %}
              </span>
            </div>
          {% endif %}
        </div>

        <!-- Total Duration & Watched Time -->
        <div class="mt-3 bg-light p-3 rounded">
          <h6 class="fw-bold mb-1">Total Duration: {{ total_duration|seconds_to_hms }}</h6>
          <h6 class="fw-bold">Total Watched Time: {{ total_watched_seconds|seconds_to_hms }}</h6>
        </div>

        <!-- Custom Progress Bar -->
        {% if user.is_authenticated %}
          <div class="video-progress-container mb-3">
            <div class="progress" style="height: 8px; background-color: #e9ecef;">
              <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                   id="main-progress-bar"
                   role="progressbar" 
                   style="width: {% with progress_dict|dict_get:video.id as prog %}{{ prog.watched_percentage|default:0 }}{% endwith %}%;"
                   aria-valuenow="{% with progress_dict|dict_get:video.id as prog %}{{ prog.watched_percentage|default:0 }}{% endwith %}" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
              </div>
            </div>
            <div class="d-flex justify-content-between mt-1">
              <small class="text-muted" id="current-time">
                {% with progress_dict|dict_get:video.id as prog %}
                  {{ prog.current_time|default:0|floatformat:0 }}
                {% endwith %}s
              </small>
              <small class="text-muted" id="duration-time">0:00</small>
            </div>
          </div>
        {% endif %}

        <!-- Description -->
        <div class="video-description mt-3">
          <p class="text-secondary mb-0">{{ video.description|linebreaks }}</p>
        </div>

        <!-- ⏮⏭ Navigation Buttons -->
        <div class="d-flex gap-2 mt-4">
          {% if previous_video %}
            <a href="{% url 'videos:video_detail' previous_video.id %}" class="btn btn-outline-secondary flex-fill">
              <i class="bi bi-skip-backward-fill"></i> Previous
            </a>
          {% endif %}
          {% if next_video %}
            <a href="{% url 'videos:video_detail' next_video.id %}" class="btn btn-primary flex-fill">
              Next <i class="bi bi-skip-forward-fill"></i>
            </a>
          {% endif %}
        </div>

        <!-- Certificate Download -->
        {% if all_completed %}
          <div class="text-center p-3 border-top mt-3">
            <a href="#" class="btn btn-success w-100 fw-semibold">
              🎓 Download Certificate
            </a>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- 📺 Right: Playlist (YouTube-style) -->
    <div class="col-lg-4">
      <div class="playlist-container bg-white rounded-3 shadow-sm">
        <div class="playlist-header p-3 border-bottom bg-light">
          <h5 class="mb-1 fw-bold">
            <i class="bi bi-collection-play"></i> Course Playlist
          </h5>
          <small class="text-muted">{{ videos|length }} videos</small>
        </div>
        
        <div class="playlist-videos" style="max-height: 600px; overflow-y: auto;">
          {% for v in videos %}
          <a href="{% url 'videos:video_detail' v.id %}" 
             class="playlist-item d-flex align-items-start text-decoration-none p-3 border-bottom
                    {% if v.id == video.id %}active{% endif %}">
            
            <!-- Thumbnail with Play Icon -->
            <div class="playlist-thumbnail position-relative flex-shrink-0 me-3">
              {% if v.thumbnail_url %}
                <img src="{{ v.thumbnail_url }}" alt="{{ v.title }}" class="rounded">
              {% else %}
                <img src="https://via.placeholder.com/168x94?text=Video+{{ v.order }}" class="rounded">
              {% endif %}
              
              <!-- Video Number Overlay -->
              <div class="video-number">{{ v.order }}</div>
              
              <!-- Completion Checkmark -->
              {% if user.is_authenticated %}
                {% with progress_dict|dict_get:v.id as prog %}
                  {% if prog and prog.watched_percentage >= 95 %}
                    <div class="completion-badge">
                      <i class="bi bi-check-circle-fill"></i>
                    </div>
                  {% endif %}
                {% endwith %}
              {% endif %}

              <!-- Currently Playing Indicator -->
              {% if v.id == video.id %}
                <div class="now-playing">
                  <i class="bi bi-play-circle-fill"></i>
                </div>
              {% endif %}
            </div>

            <!-- Title + Progress -->
            <div class="playlist-info flex-grow-1">
              <p class="playlist-title mb-1 fw-semibold {% if v.id == video.id %}text-primary{% else %}text-dark{% endif %}">
                {{ v.title }}
              </p>
              
              <!-- Progress Bar for Each Video -->
              {% if user.is_authenticated %}
                {% with progress_dict|dict_get:v.id as prog %}
                  {% if prog %}
                    <div class="progress mb-1" style="height: 3px;">
                      <div class="progress-bar {% if prog.watched_percentage >= 95 %}bg-success{% else %}bg-primary{% endif %}" 
                           style="width: {{ prog.watched_percentage|default:0 }}%;"></div>
                    </div>
                    <small class="text-muted">{{ prog.watched_percentage|floatformat:0 }}% watched</small>
                  {% else %}
                    <small class="text-muted">Not started</small>
                  {% endif %}
                {% endwith %}
              {% else %}
                <small class="text-muted">{{ v.channel.name }}</small>
              {% endif %}
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 🎨 Styles -->
<style>
/* Your existing CSS styles remain the same */
.video-container {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  background: #000;
  transition: transform 0.3s ease;
}

.video-container:hover {
  transform: scale(1.01);
}

.video-container iframe {
  display: block;
  width: 100%;
  height: 500px;
  border-radius: 12px;
}

.video-info {
  border: 1px solid #e9ecef;
  padding: 1.5rem;
  background: #fff;
  border-radius: 12px;
  transition: box-shadow 0.3s ease;
}

.video-info:hover {
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.video-title {
  font-size: 1.7rem;
  font-weight: 700;
  color: #0d0d0d;
  line-height: 1.4;
}

.channel-avatar {
  width: 50px;
  height: 50px;
  flex-shrink: 0;
}

.channel-avatar img,
.avatar-placeholder {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 50%;
}

.avatar-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  background: #0d6efd;
  color: #fff;
}

.progress-badge .badge {
  font-size: 0.95rem;
  font-weight: 600;
  border-radius: 12px;
}

.video-progress-container .progress {
  height: 8px;
  border-radius: 10px;
  background-color: #e9ecef;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
}

.video-progress-container .progress-bar {
  border-radius: 10px;
  transition: width 0.4s ease, background-color 0.3s ease;
}

.btn {
  border-radius: 8px;
  font-weight: 600;
  padding: 10px 18px;
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.playlist-container {
  border: 1px solid #e9ecef;
  border-radius: 12px;
  position: sticky;
  top: 20px;
  background: #fff;
  overflow: hidden;
  transition: box-shadow 0.3s ease;
}

.playlist-container:hover {
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.playlist-header {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #e9ecef;
  background: #f8f9fa;
  font-weight: 600;
}

.playlist-videos {
  max-height: 600px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e0 #f7fafc;
}

.playlist-videos::-webkit-scrollbar {
  width: 8px;
}
.playlist-videos::-webkit-scrollbar-track {
  background: #f7fafc;
}
.playlist-videos::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 10px;
}
.playlist-videos::-webkit-scrollbar-thumb:hover {
  background: #a0aec0;
}

.playlist-item {
  display: flex;
  align-items: start;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  text-decoration: none;
  transition: background 0.2s ease;
  border-bottom: 1px solid #e9ecef;
  color: #0d0d0d;
}

.playlist-item:hover {
  background-color: #f1f5f9;
}

.playlist-item.active {
  background-color: #e7f3ff;
  border-left: 4px solid #0d6efd;
}

.playlist-thumbnail {
  width: 168px;
  height: 94px;
  position: relative;
  flex-shrink: 0;
}

.playlist-thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
  border: 2px solid #e9ecef;
  transition: border-color 0.3s ease;
}

.playlist-item.active .playlist-thumbnail img {
  border-color: #0d6efd;
}

.video-number {
  position: absolute;
  bottom: 6px;
  left: 6px;
  background: rgba(0,0,0,0.75);
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
}

.completion-badge {
  position: absolute;
  top: 6px;
  right: 6px;
  background: #198754;
  color: #fff;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

.now-playing {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 32px;
  color: #0d6efd;
  text-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

.playlist-title {
  font-size: 0.95rem;
  font-weight: 500;
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.playlist-item .progress {
  height: 4px;
  border-radius: 2px;
  background-color: #e9ecef;
  margin-bottom: 2px;
}

@media (max-width: 991px) {
  .video-container iframe {
    height: 380px;
  }
  .playlist-container {
    position: static;
    margin-top: 1.5rem;
  }
}

@media (max-width: 576px) {
  .video-container iframe {
    height: 250px;
  }
  .playlist-thumbnail {
    width: 120px;
    height: 68px;
  }
  .video-title {
    font-size: 1.3rem;
  }
}
</style>

<!-- 🧠 YouTube IFrame API & Progress Tracking -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
// Global variables
let player = null;
let updateInterval = null;
let lastSentTime = 0;
let isSaving = false;
let playerReady = false;

// Fallback: If YouTube API doesn't load in time
setTimeout(() => {
    if (!window.YT && !playerReady) {
        console.log('YouTube API not loaded, initializing fallback');
        initializeFallbackPlayer();
    }
}, 5000);

function initializeFallbackPlayer() {
    console.log('Using fallback player initialization');
    const iframe = document.getElementById('player');
    if (iframe) {
        player = {
            getCurrentTime: () => 0,
            getDuration: () => 0,
            getPlayerState: () => 0
        };
        startFallbackProgressUpdates();
    }
}

function startFallbackProgressUpdates() {
    // Fallback progress updates for when YouTube API fails
    setInterval(() => {
        updateTimeDisplay();
    }, 1000);
}

function updateTimeDisplay() {
    const currentTimeElem = document.getElementById('current-time');
    if (currentTimeElem) {
        // Just show placeholder time if player not working
        currentTimeElem.innerText = '0:00';
    }
}

function onYouTubeIframeAPIReady() {
    console.log('YouTube API Ready - Initializing player');
    try {
        player = new YT.Player('player', {
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': onPlayerError
            }
        });
    } catch (error) {
        console.error('Error initializing YouTube player:', error);
        initializeFallbackPlayer();
    }
}

function onPlayerReady(event) {
    console.log('Player Ready - Video can be played');
    playerReady = true;
    updateDuration();
    
    // Start background updates regardless of player state
    setInterval(() => {
        if (player && player.getCurrentTime) {
            updateProgress();
        }
    }, 1000);
}

function onPlayerError(event) {
    console.error('YouTube Player Error:', event.data);
}

function onPlayerStateChange(event) {
    console.log('Player State Changed:', getStateName(event.data));
    
    if (event.data === YT.PlayerState.PLAYING) {
        if (!updateInterval) {
            updateInterval = setInterval(updateProgress, 1000);
        }
    } else if ([YT.PlayerState.PAUSED, YT.PlayerState.ENDED, YT.PlayerState.BUFFERING].includes(event.data)) {
        updateProgress(); // Always update on state change
    }
    
    // Auto-play next video when current ends
    {% if next_video %}
    if (event.data === YT.PlayerState.ENDED) {
        setTimeout(() => {
            console.log('Video ended, redirecting to next video');
            window.location.href = "{% url 'videos:video_detail' next_video.id %}";
        }, 1500);
    }
    {% endif %}
}

function getStateName(state) {
    const states = {
        [-1]: 'UNSTARTED',
        [0]: 'ENDED',
        [1]: 'PLAYING',
        [2]: 'PAUSED',
        [3]: 'BUFFERING',
        [5]: 'CUED'
    };
    return states[state] || 'UNKNOWN';
}

function updateDuration() {
    if (!player || typeof player.getDuration !== 'function') return;
    
    try {
        const duration = player.getDuration();
        if (duration && duration > 0) {
            document.getElementById('duration-time').innerText = formatTime(duration);
        } else {
            // Retry after a delay if duration not available
            setTimeout(updateDuration, 1000);
        }
    } catch (error) {
        console.error('Error getting duration:', error);
    }
}

function updateProgress() {
    if (!player || typeof player.getCurrentTime !== 'function' || typeof player.getDuration !== 'function') {
        console.log('Player methods not available');
        return;
    }
    
    try {
        const currentTime = player.getCurrentTime();
        const duration = player.getDuration();
        
        if (duration > 0 && currentTime >= 0) {
            const watched_percentage = Math.min((currentTime / duration) * 100, 100);
            const percentageDisplay = watched_percentage.toFixed(1);
            
            // Update progress badge
            const progressBadge = document.getElementById('progress-badge');
            if (progressBadge) {
                progressBadge.innerHTML = `<i class="bi bi-clock-history"></i> ${percentageDisplay}% Complete`;
            }

            // Update main progress bar
            const mainProgressBar = document.getElementById('main-progress-bar');
            if (mainProgressBar) {
                mainProgressBar.style.width = watched_percentage + '%';
                mainProgressBar.setAttribute('aria-valuenow', watched_percentage);
                
                // Change color when complete
                if (watched_percentage >= 95) {
                    mainProgressBar.classList.remove('bg-primary');
                    mainProgressBar.classList.add('bg-success');
                } else {
                    mainProgressBar.classList.remove('bg-success');
                    mainProgressBar.classList.add('bg-primary');
                }
            }

            // Update time display
            const currentTimeElem = document.getElementById('current-time');
            if (currentTimeElem) {
                currentTimeElem.innerText = formatTime(currentTime);
            }

            // Save progress to server (with throttling)
            if (Math.abs(currentTime - lastSentTime) > 3 && !isSaving && {% if user.is_authenticated %}true{% else %}false{% endif %}) {
                saveProgressToServer(currentTime, watched_percentage);
            }
        }
    } catch (error) {
        console.error('Error updating progress:', error);
    }
}

function saveProgressToServer(currentTime, watched_percentage) {
    isSaving = true;
    
    fetch("{% url 'videos:save_progress' video.id %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
            current_time: currentTime,
            watched_percentage: watched_percentage
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        console.log('Progress saved successfully:', data);
        lastSentTime = currentTime;
    })
    .catch(err => {
        console.error('Progress save failed:', err);
    })
    .finally(() => {
        isSaving = false;
    });
}

function formatTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return '0:00';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    return `${minutes}:${String(secs).padStart(2, '0')}`;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Save progress before leaving page
window.addEventListener('beforeunload', updateProgress);

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - setting up video player');
    
    // Start duration updates
    setTimeout(updateDuration, 2000);
    
    // Fallback: If player not ready after 3 seconds, use fallback
    setTimeout(() => {
        if (!playerReady && !player) {
            console.log('Player not ready after 3 seconds, using fallback');
            initializeFallbackPlayer();
        }
    }, 3000);
});

// Global error handler for YouTube API
window.addEventListener('error', function(e) {
    if (e.message && e.message.includes('YT')) {
        console.error('YouTube API error detected:', e);
        initializeFallbackPlayer();
    }
});
</script>
{% endblock %}