{% extends 'channels/base.html' %}
{% load dict_filters %}
{% load time_filters %}
{% block title %}{{ channel.name }} - Videos{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row g-4">
        <!-- Left: Video List -->
        <div class="col-lg-8">
            <h3 class="mb-3">{{ channel.name }} - Videos</h3>

            {% if videos %}
                <div class="list-group list-group-flush">
                    {% for video in videos %}
                        <a href="{% url 'videos:video_detail' video.id %}" 
                           class="list-group-item list-group-item-action d-flex align-items-center p-3 {% if current_video and video.id == current_video.id %}active{% endif %}"
                           data-video-id="{{ video.id }}"
                           id="video-item-{{ video.id }}">
                            <!-- Thumbnail -->
                            <div class="flex-shrink-0 position-relative me-3">
                                <img src="{{ video.thumbnail_url|default:'https://via.placeholder.com/160x90?text=No+Image' }}" 
                                     alt="{{ video.title }}" class="rounded" style="width:160px; height:90px; object-fit:cover;">

                                {% if user.is_authenticated %}
                                    {% with progress_dict|dict_get:video.id as prog %}
                                        {% if prog and prog.watched_percentage >= 95 %}
                                            <div class="completion-badge position-absolute top-0 end-0 m-1">
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </div>

                            <!-- Video Info -->
                            <div class="flex-grow-1">
                                <h6 class="mb-1 {% if current_video and video.id == current_video.id %}text-white{% else %}text-dark{% endif %}">
                                    {{ video.title }}
                                </h6>
                                <small class="text-muted d-block">{{ video.description|truncatechars:100 }}</small>

                                {% if user.is_authenticated %}
                                    {% with progress_dict|dict_get:video.id as prog %}
                                        {% if prog %}
                                            <div class="progress mt-2" style="height:6px; border-radius:4px;">
                                                <div class="progress-bar {% if prog.watched_percentage >= 95 %}bg-success{% else %}bg-primary{% endif %}" 
                                                     style="width:{{ prog.watched_percentage|default:0 }}%;" 
                                                     id="progress-bar-{{ video.id }}"></div>
                                            </div>
                                            <small class="text-muted" id="progress-text-{{ video.id }}">{{ prog.watched_percentage|floatformat:0 }}% watched</small>
                                        {% else %}
                                            <small class="text-muted">Not started</small>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </div>

                            <!-- Currently Playing Icon -->
                            {% if current_video and video.id == current_video.id %}
                                <i class="bi bi-play-circle-fill fs-3 text-primary ms-3"></i>
                            {% endif %}
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No videos available in this channel.</p>
            {% endif %}
        </div>

        <!-- Right: Channel Info / Sidebar -->
        <div class="col-lg-4">
            <div class="bg-white rounded-3 shadow-sm p-4 sticky-top" style="top:20px;">
                <h5 class="fw-bold mb-3">Channel Info</h5>

                {% if channel.ch_logo %}
                    <img src="{{ channel.ch_logo }}" class="rounded-circle mb-3" style="width:100px; height:100px; object-fit:cover;">
                {% else %}
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mb-3" 
                         style="width:100px; height:100px; font-size:36px;">
                        {{ channel.name|slice:":1"|upper }}
                    </div>
                {% endif %}

                <h6 class="fw-semibold">{{ channel.name }}</h6>

                <!-- Expandable Channel Description -->
                <div class="channel-description text-muted mb-2" 
                     id="desc-text" 
                     style="font-size:0.95rem; line-height:1.5; max-height:4.5em; overflow:hidden;">
                    {{ channel.description|default:"No description available."|linebreaksbr }}
                </div>
                <button class="btn btn-link p-0" id="toggle-desc" style="font-size:0.9rem;">Show more</button>

                <hr>
                <h6 class="fw-bold">Videos Count: {{ videos|length }}</h6>
                <h6 class="fw-bold">
                  Total Watched Time: {{ total_watched_seconds|seconds_to_hms }}
                </h6>

                <!-- Certificate Button Placeholder -->
                <div id="certificate-container" class="mt-3" style="display:none;">
                    <a href="#" class="btn btn-success w-100">
                        ðŸŽ“ Download Certificate
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS for Expandable Description & Certificate -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Expandable description
    const btn = document.getElementById("toggle-desc");
    const desc = document.getElementById("desc-text");
    let expanded = false;
    btn.addEventListener("click", function() {
        expanded = !expanded;
        if (expanded) {
            desc.style.maxHeight = "none";
            btn.textContent = "Show less";
        } else {
            desc.style.maxHeight = "4.5em";
            btn.textContent = "Show more";
        }
    });

    // Function to check if all videos are completed
    function checkAllVideosCompleted() {
        const videoItems = document.querySelectorAll('[data-video-id]');
        let allCompleted = true;

        videoItems.forEach(item => {
            const videoId = item.getAttribute('data-video-id');
            const progressBar = document.getElementById(`progress-bar-${videoId}`);
            if (progressBar) {
                const width = parseFloat(progressBar.style.width);
                if (isNaN(width) || width < 95) {
                    allCompleted = false;
                }
            } else {
                allCompleted = false;
            }
        });

        const certBtn = document.getElementById('certificate-container');
        if (allCompleted) {
            certBtn.style.display = 'block';
        } else {
            certBtn.style.display = 'none';
        }
    }

    // Check initially
    checkAllVideosCompleted();

    // Check periodically every 3s
    setInterval(checkAllVideosCompleted, 3000);

    // Optional: call after each video progress update (if using updateProgress from detail.html)
    window.updateListProgress = checkAllVideosCompleted;
});
</script>

<!-- Optional CSS for smooth transition and styling -->
<style>
.list-group-item.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}
.list-group-item img {
    border-radius: 8px;
}
.list-group-item .progress {
    border-radius: 4px;
}
.completion-badge {
    width:24px;
    height:24px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:absolute;
    top:4px;
    right:4px;
}
.channel-description {
    transition: max-height 0.3s ease;
}
</style>
{% endblock %}
